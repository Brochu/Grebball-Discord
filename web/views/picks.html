<!doctype html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link rel="icon" type="image/x-icon" href="/favicon-16.ico">

    <style>
        .fs-8 {
          font-size: 0.7rem;
        }
        .no-pad {
            padding: 5px;
            width: 150px;
        }
        .progress-container {
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-check:checked + .btn .text-muted {
            color: white !important
        }
    </style>

    <title>Grebball - Picks</title>
</head>

<body>
<nav class="navbar navbar-expand-md navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Grebball - Choix</a>

        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
            </ul>

            <div class="px-5 form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="themeToggle">
                <label class="form-check-label" for="themeToggle" id="themeLabel"></label>
            </div>

            <div class="d-flex" role="user" style="padding-right: 1em">
            <span style="color: white">
                <img src="/teams/<%= favteam %>.png" width=60 height=60 />
                <%= username %>
            </span>
            </div>
            <div class="d-flex" role="user">
                <img class="img-fluid rounded-circle" src="<%= avatar %>" width=64 height=64 />
            </div>
        </div>
    </div>
</nav>

<main class="container responsive-container">
<div class="bg-body-tertiary p-5 rounded">
    <span class="h2">Choix pour saison: <%= season %>, semaine: <%= week %></span>

    <!-- Progress Bar Section -->
    <div class="progress-container mt-4">
        <div class="progress" style="height: 25px;">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" 
                 style="width: 0%;" 
                 aria-valuenow="0" 
                 aria-valuemin="0" 
                 aria-valuemax="<%= matches.length %>">
                0%
            </div>
        </div>
    </div>

    <form action="/submit" method="post" id="picks-form">
    <input type="hidden" name="pickid" value="<%= pickid %>" />
    <input type="hidden" name="matchids" value="<%= matchids %>" />
    <input type="hidden" name="favteam" value="<%= favteam %>" />
    <input type="hidden" name="forcedid" value="<%= forcedid %>" />

    <div class="container my-4">
        <div class="row row-cols-1 row-cols-sm-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-2">

            <% matches.forEach((m) => { %>
            <div class="col">
                <div class="card h-100 border-<%= m.featured ? 'warning' : 'primary' %>">
                    <div class="card-header d-flex flex-column align-items-center">
                        <span class="small text-muted display-date"><%= m['date'].toISOString() %></span>
                    </div>
                    <div class="card-body">
                        <div class="text-center">
                            <div class="row mx-1">
                                <input type="radio" class="btn-check match-pick" name="<%=m['idEvent']%>" id="<%=m['awayTeam']%>" value="<%=m['awayTeam']%>"
                                <% if (favteam === m['awayTeam'] || favteam === m['homeTeam']) { %>
                                    <% if (favteam === m['awayTeam']) { %> checked <% } else { %> disabled <% } %>
                                <% } %>>
                                <label class="btn btn-outline-<%= m.featured ? 'warning' : 'primary' %>" for="<%=m['awayTeam']%>">
                                    <div class="row align-items-center">
                                        <div class="col-2"> <img src="/teams/<%=m['awayTeam']%>.png" width="45" height="45"> </div>
                                        <div class="col"> <small class="text-muted"><%= m['strAwayTeam']%></small> </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-2"></div>
                                        <div class="col fs-8">
                                            <span class="text-muted px-1"><%= m['awayRecordAll']['summary'] %></span>
                                            ‚Ä¢
                                            <span class="text-muted px-1"><%= m['awayRecordAlt']['summary'] %> <%= m['awayRecordAlt']['name'] %></span>
                                        </div>
                                    </div>
                                </label>
                            </div>

                            <div class="fs-5"> @ </div>

                            <div class="row mx-1">
                                <input type="radio" class="btn-check match-pick" name="<%=m['idEvent']%>" id="<%=m['homeTeam']%>" value="<%=m['homeTeam']%>"
                                <% if (favteam === m['awayTeam'] || favteam === m['homeTeam']) { %>
                                    <% if (favteam === m['homeTeam']) { %> checked <% } else { %> disabled <% } %>
                                <% } %>>
                                <label class="btn btn-outline-<%= m.featured ? 'warning' : 'primary' %>" for="<%=m['homeTeam']%>">
                                    <div class="row align-items-center">
                                        <div class="col-2"> <img src="/teams/<%=m['homeTeam']%>.png" width="45" height="45"> </div>
                                        <div class="col"> <small class="text-muted"><%= m['strHomeTeam']%></small> </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-2"></div>
                                        <div class="col fs-8">
                                            <span class="text-muted px-1"><%= m['homeRecordAll']['summary'] %></span>
                                            ‚Ä¢
                                            <span class="text-muted px-1"><%= m['homeRecordAlt']['summary'] %> <%= m['homeRecordAlt']['name'] %></span>
                                        </div>
                                    </div>
                                </label>
                            </div>
                        </div>

                        <% if (m.featured) { %>
                            <hr class="w-100" style="margin: 5px 0px;">
                            <!-- Over/Under Section -->
                            <div class="text-center text-muted small">Total de <%= feat_val %>.5 points?</div>
                            <div class="btn-group w-100 mt-2" role="group">
                                <input type="radio"
                                    class="btn-check btn-outline-warning featured-pick"
                                    name="feat_pick" id="PLUS" value="1">
                                </input>
                                <label
                                    class="btn btn-outline-warning d-flex flex-column align-items-center no-pad"
                                    for="PLUS"
                                >
                                    PLUS
                                </label>

                                <input type="radio"
                                    class="btn-check btn-outline-warning featured-pick"
                                    name="feat_pick" id="MOINS" value="0">
                                </input>
                                <label
                                    class="btn btn-outline-warning d-flex flex-column align-items-center no-pad"
                                    for="MOINS"
                                >
                                    MOINS
                                </label>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
            <% }) %>

        </div>
    </div>

    <div class="container my-4 d-flex flex-column align-items-center">
        <button type="submit" id="submit-btn" class="btn btn-primary" disabled>Submit</button>
    </div>
    </form>
</div>
</main>

<script src="/js/bootstrap.min.js"></script>
<script>
    // Convert dates to local time
    document.querySelectorAll('.display-date').forEach(el => {
        const utcStr = el.textContent;
        const date = new Date(utcStr);
        el.textContent = date.toLocaleString();
    });

    // Progress tracking
    const totalMatches = <%= matches.length %>;
    const hasFeatured = <%= matches.some(m => m.featured) ? 'true' : 'false' %>;
    const submitBtn = document.getElementById('submit-btn');
    const progressBar = document.getElementById('progress-bar');

    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const htmlElement = document.documentElement;

    const savedTheme = localStorage.getItem('theme') || 'light';
    htmlElement.setAttribute('data-bs-theme', savedTheme);
    themeToggle.checked = (savedTheme === 'light') ? "checked" : "";
    themeLabel.innerHTML = (savedTheme === 'light') ? '‚òÄÔ∏è' : 'üåô';

    function updateProgress() {
        // Get all unique match groups (by name attribute)
        const matchGroups = {};
        document.querySelectorAll('.match-pick').forEach(radio => {
            matchGroups[radio.name] = matchGroups[radio.name] || [];
            matchGroups[radio.name].push(radio);
        });

        // Count how many matches have a selection
        let completedMatches = 0;
        Object.values(matchGroups).forEach(group => {
            if (group.some(radio => radio.checked)) {
                completedMatches++;
            }
        });

        // Check if featured pick is completed
        let featuredCompleted = true;
        if (hasFeatured) {
            const featuredPicks = document.querySelectorAll('.featured-pick');
            featuredCompleted = Array.from(featuredPicks).some(radio => radio.checked);
        }

        // Calculate total required picks
        const totalRequired = hasFeatured ? totalMatches + 1 : totalMatches;
        const totalCompleted = completedMatches + (hasFeatured && featuredCompleted ? 1 : 0);

        // Update progress bar
        const percentage = (totalCompleted / totalRequired) * 100;
        progressBar.style.width = percentage + '%';
        progressBar.textContent = Math.round(percentage) + '%';
        progressBar.setAttribute('aria-valuenow', totalCompleted);

        // Update button state
        const allComplete = totalCompleted === totalRequired;
        submitBtn.disabled = !allComplete;

        // Update progress bar color
        if (allComplete) {
            progressBar.classList.remove('bg-secondary', 'progress-bar-animated');
            progressBar.classList.add('bg-success');
        } else {
            progressBar.classList.remove('bg-success');
            progressBar.classList.add('progress-bar-animated');
        }
    }

    // Add event listeners to all radio buttons
    document.querySelectorAll('.match-pick, .featured-pick').forEach(radio => {
        radio.addEventListener('change', updateProgress);
    });

    themeToggle.addEventListener('click', function(e) {
        const currentTheme = htmlElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        htmlElement.setAttribute('data-bs-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        themeLabel.innerHTML = (newTheme === 'light') ? '‚òÄÔ∏è' : 'üåô';
    });

    // Show warning on submit attempt when incomplete
    submitBtn.addEventListener('click', function(e) {
        if (this.disabled) {
            e.preventDefault();
        }
    });

    // Initial progress check
    updateProgress();
</script>

</body>
</html>
